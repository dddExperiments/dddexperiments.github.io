"use strict";var PS=PS||{};PS.API={},PS.API.Filters={None:"None",Synths:"Synths",Panos:"Panos",SynthPackets:"SynthPackets",All:"All"},PS.API.TimeFilters={Last7Days:"Last7Days",Last30Days:"Last30Days",AllTime:"AllTime"},PS.API.OrderBy={Views:"Views",Rank:"Rank",Favorites:"Favorites"},PS.API.TextResultOrdering={Descending:"Descending",Ascending:"Ascending"},PS.API.TextSortCriteria={BestMatch:"BestMatch",BestSynth:"BestSynth",DateAdded:"DateAdded",NumberOfViews:"NumberOfViews",CreatedBy:"CreatedBy"},PS.API.getRootUrl=function(){return"https://photosynth.net/rest/2014-08/"},PS.API.convertCollection=function(collection){var item=collection,synth={guid:item.Id,name:item.Name,description:item.Description||"",nbFavorites:item.FavoriteCount||0,nbComments:item.CommentCount||0,nbViews:item.Viewings||0,nbPhotos:item.ImageCount||1,privacy:item.PrivacyLevel||"",thumb:item.ThumbnailUrl||"",username:item.OwnerUsername||item.OwnerFriendlyName||"",rank:item.Rank||0,url:item.CollectionUrl||"",date:item.CapturedDate?new Date(eval("new "+item.CapturedDate.replace(/[\\/]/g,"").replace("+0000",""))):new Date};return item.Synth?(synth.type="Synth",item.Synth.SynthinessScore&&(synth.synthy=item.Synth.SynthinessScore)):item.Panorama?(synth.type="Panorama",item.Panorama.Megapixels&&(synth.megapixels=item.Panorama.Megapixels)):item.SynthPacket?(synth.type="PS2",item.SynthPacket.Topology&&(synth.topology=item.SynthPacket.Topology)):synth.type="Unknown",item.GeoTag&&item.GeoTag.Latitude&&item.GeoTag.Longitude&&(synth.latitude=item.GeoTag.Latitude,synth.longitude=item.GeoTag.Longitude,synth.zoomLevel=item.MapZoomLevel||12),synth},PS.API.convertCollections=function(a){return a.map(function(a){return PS.API.convertCollection(a)})},PS.API._validateGenericRequestOptions=function(a){return a.maxItems=Math.max(a.maxItems,1),a.numRows=Math.max(a.numRows,1),a.numRows=Math.min(a.numRows,100),a.numRows=Math.min(a.maxItems,a.numRows),a},PS.API._genericRequest=function(a,b){var c={numRows:50,filter:"",maxItems:300,onProgress:function(){},onComplete:function(){},onError:function(){}};PS.extend(c,b),c=PS.API._validateGenericRequestOptions(c),new PS.Utils.Request(a(0),{onComplete:function(b){var d=PS.Utils.tryParse(b.responseText);if(d){var e=d.Collections,f=Math.min(d.TotalResults,c.maxItems);if(f>c.numRows){var g=Math.ceil(f/c.numRows)-1,h=0,i=new Array(g+1);i[0]=e;var j=PS.Utils.generateRangeArray(g);j=j.map(function(a){return a+1}),new PS.Utils.Async.Queue(j,{concurrency:8,onProcess:function(b,d){h++,c.onProgress(h/g);var e=b*c.numRows;new PS.Utils.Request(a(e),{onComplete:function(a){var c=PS.Utils.tryParse(a.responseText);i[b]=c?c.Collections:[],d()},onError:function(){i[b]=[],d()}})},onComplete:function(){for(var a=[],b=0;b<i.length;++b)a=a.concat(i[b]);c.onComplete(PS.API.convertCollections(a.slice(0,c.maxItems)))}})}else c.onComplete(PS.API.convertCollections(e.slice(0,c.maxItems)))}else c.onError(b)}})},PS.API.getUsername=function(a){new PS.Utils.Request(PS.API.getRootUrl()+"me",{onComplete:function(b){var c=PS.Utils.tryParse(b.responseText);a(c?c.Username:"")},onError:function(){a("")}})},PS.API.getMedia=function(a,b){new PS.Utils.Request(PS.API.getRootUrl()+"media/"+a,{onComplete:function(a){var c=PS.Utils.tryParse(a.responseText);b(c?PS.API.convertCollection(c):null)},onError:function(){b()}})},PS.API.getAnnotations=function(a,b){new PS.Utils.Request(PS.API.getRootUrl()+"media/"+a+"/annotations",{onComplete:function(a){var c=PS.Utils.tryParse(a.responseText);if(c){var d=c.map(function(a){var b={Auto:0,All:1,One:2,Manual:3};return{worldPoint:a.Placement.WorldPoint,queryPoint:a.Placement.QueryPoint,visibility:a.Placement.Visibility,visibilityPreset:b[a.Placement.Preset],radius:a.Placement.Radius,text:a.Description,dbid:a.AnnotationId.toString(),imgIndex:a.Placement.ImageIndex,surfaceOrientation:a.Placement.Orientation}});b(d)}else b([])},onError:function(){b([])}})},PS.API.getPS2Url=function(a,b){PS.API.getMedia(a,function(a){if(a)if("PS2"===a.type){var c=a.url.replace("0.json","");b(c)}else b();else b()})},PS.API.getListOfMostRecentSynths=function(a){function b(a){var b=PS.API.getRootUrl()+"media/explore/?order=Date&numRows="+c.numRows+"&offset="+a;return c.filter&&(b+="&collectionTypeFilter="+c.filter),b}var c={numRows:50,filter:"",maxItems:300,onProgress:function(){},onComplete:function(){}};PS.extend(c,a),c=PS.API._validateGenericRequestOptions(c),PS.API._genericRequest(b,c)},PS.API.getListOfMostFavoriteSynths=function(a){function b(a){var b=PS.API.getRootUrl()+"media/explore/?order="+c.order+"&time="+c.timeFilter+"&numRows="+c.numRows+"&offset="+a;return c.filter&&(b+="&collectionTypeFilter="+c.filter),b}var c={numRows:50,filter:"",maxItems:300,onProgress:function(){},onComplete:function(){},timeFilter:PS.API.TimeFilters.Last7Days,order:PS.API.OrderBy.Favorites};PS.extend(c,a),c=PS.API._validateGenericRequestOptions(c),PS.API._genericRequest(b,c)},PS.API.getListOfFavoriteUserSynth=function(a,b){function c(a,b){var c=PS.API.getRootUrl()+"users/"+b+"/favorites?numRows="+d.numRows+"&offset="+a;return d.filter&&(c+="&collectionTypeFilter="+d.filter),c}var d={numRows:50,filter:"",maxItems:300,onProgress:function(){},onComplete:function(){}};PS.extend(d,b),d=PS.API._validateGenericRequestOptions(d),PS.API._genericRequest(function(){var b=a;return function(a){return c(a,b)}}(),d)},PS.API.getListOfUserSynth=function(a,b){function c(a,b){var c=PS.API.getRootUrl()+"users/"+b+"/media?numRows="+d.numRows+"&offset="+a;return d.filter&&(c+="&collectionTypeFilter="+d.filter),c}var d={numRows:50,filter:"",maxItems:300,onProgress:function(){},onComplete:function(){}};PS.extend(d,b),d=PS.API._validateGenericRequestOptions(d),PS.API._genericRequest(function(){var b=a;return function(a){return c(a,b)}}(),d)},PS.API.textSearchForSynths=function(a,b){function c(a,b,c,e){var f=PS.API.getRootUrl()+"search/?numRows="+d.numRows+"&offset="+a+"&sortby="+c+"&orderby="+e+"&q="+encodeURI(b);return d.filter&&(f+="&collectionTypeFilter="+d.filter),f}var d={numRows:50,filter:"",maxItems:300,onProgress:function(){},onComplete:function(){},sort:PS.API.TextSortCriteria.BestMatch,ordering:PS.API.TextResultOrdering.Descending};PS.extend(d,b),d=PS.API._validateGenericRequestOptions(d),PS.API._genericRequest(function(){var b=a,e=d.sort,f=d.ordering;return function(a){return c(a,b,e,f)}}(),d)},PS.API.getNearestSynthsByBBox=function(a,b,c,d,e){var f=e||{};f.mode="bbox",f.nlat=c,f.elon=d,PS.API.getNearestSynths(a,b,f)},PS.API.getNearestSynthsByRadius=function(a,b,c){var d=c||{};d.mode="nearby",PS.API.getNearestSynths(a,b,c)},PS.API.getNearestSynths=function(a,b,c){function d(a){var b=PS.API.getRootUrl()+"search/"+e.mode+"?numRows="+e.numRows+"&offset="+a;return b+="nearby"===e.mode?"&lat="+e.slat+"&lon="+e.wlon+"&radius="+e.radius:"&slat="+e.slat+"&wlon="+e.wlon+"&nlat="+e.nlat+"&elon="+e.elon,e.filter&&(b+="&collectionTypeFilter="+e.filter),b}var e={mode:"nearby",slat:a,wlon:b,nlat:a,elon:b,numRows:50,filter:"",radius:2e3,maxItems:500,loggedUser:"",onProgress:function(){},onComplete:function(){}};PS.extend(e,c),e=PS.API._validateGenericRequestOptions(e),PS.API._genericRequest(d,e)},PS.API.getInfoSoap=function(a,b){var c="";c+="<?xml version='1.0' encoding='utf-8'?>",c+="<soap12:Envelope xmlns:xsi='http://www.w3.orgf589631b-1d74-47ac-a09e-6fe6590df796/2001/XMLSchema-instance' xmlns:xsd='http://www.w3.org/2001/XMLSchema' xmlns:soap12='http://www.w3.org/2003/05/soap-envelope'>",c+="  <soap12:Body>",c+="    <GetCollectionData xmlns='http://labs.live.com/'>",c+="      <collectionId>"+a+"</collectionId>",c+="      <incrementEmbedCount>false</incrementEmbedCount>",c+="    </GetCollectionData>",c+="  </soap12:Body>",c+="</soap12:Envelope>",new PS.Utils.Request("/photosynthws/PhotosynthService.asmx",{method:"POST",content:c,headers:[{name:"Content-Type",value:"application/soap+xml; charset=utf-8"}],onComplete:function(a){b(a.responseXML)},onError:function(){b()}})},PS.API.getSynths=function(a,b){var b=b||function(){},c=new FormData;c.append("collectionId",""),c.append("cmd","mostViewed"===a?"retrievemostviewedsynths":"retrieverecentsynths"),c.append("text","48,0,Last7Days,4,False"),new PS.Utils.Request("/PhotosynthHandler.ashx",{method:"POST",content:c,onComplete:function(a){b(JSON.parse(a.responseText).Collections)},onError:function(){b([])}})},PS.API.SimpleAnnotationProxy=new function(){var a="This annotation storage is read-only",b=this;this.init=function(a){a&&a(b)},this.load=function(a,b){PS.API.getAnnotations(a,b)},this.insert=function(){console.warn(a)},this.update=function(){console.warn(a)},this.remove=function(){console.warn(a)}},PS.API.SimpleAnnotationStorage=new function(){var a="",b=this,c="You need to initialize the SimpleAnnotationStorage to be able to use it!\nYou need to add PS.API.SimpleAnnotationStorage.init(_annotationStorageURL, _annotationStoragePort);";this.init=function(d,e,f){d&&e?(a="http://"+d+":"+e+"/",new PS.Utils.Request(a+"status",{onComplete:function(a){console.log("Node.js MongoDB running: "+a.responseText),f&&f(b)},onError:function(){console.warn("You need to run the fake node.js/mongodb storage"),f&&f()}})):console.warn(c)},this.load=function(b,d){a?new PS.Utils.Request(a+"synths/"+b,{method:"GET",onComplete:function(a){var b=JSON.parse(a.responseText);d(b)},onError:function(){d([])}}):console.warn(c)},this.insert=function(b,d,e,f){a?new PS.Utils.Request(a+"synths/"+b,{method:"POST",content:JSON.stringify(d),onComplete:function(a){var b=JSON.parse(a.responseText);f(b.dbid)}}):console.warn(c)},this.update=function(b,d,e){a?new PS.Utils.Request(a+"synths/"+b,{method:"PUT",content:JSON.stringify(d),onComplete:function(a){var b=JSON.parse(a.responseText);e(b.dbid)}}):console.warn(c)},this.remove=function(b,d){a?d.dbid&&new PS.Utils.Request(a+"synths/"+b,{method:"DELETE",content:JSON.stringify({dbid:d.dbid})}):console.warn(c)}},PS.API.SimpleFileWriter=new function(){var a="",b=this,c="You need to initialize the SimpleFileWriter to be able to use it!\nYou need to add PS.API.SimpleFileWriter.init(_simpleFileWriterUrl, _simpleFileWriterPort);";this.init=function(d,e,f){d&&e?(a="http://"+d+":"+e+"/",new PS.Utils.Request(a+"status",{onComplete:function(a){console.log("File Writer running: "+a.responseText),f&&f(b)},onError:function(){console.warn("You need to run the node.js File Writer"),f&&f()}})):console.warn(c)},this.save=function(b,d,e){a?new PS.Utils.Request(a+"?filename="+b,{method:"POST",content:d,onComplete:function(){e()}}):console.warn(c)}},PS.API.SimpleStaticStorage=new function(){var a={},b=this;this.init=function(c,d){new PS.Utils.Request(c,{onComplete:function(c){var e=JSON.parse(c.responseText);e.length>0&&e.forEach(function(b){a[b.guid]=b.annotations}),d&&d(b)},onError:function(){d&&d()}})},this.load=function(b,c){var d=a[b];c(d||[])},this.insert=function(){console.warn("Insert is not supported by the SimpleStaticStorage")},this.update=function(){console.warn("Update is not supported by the SimpleStaticStorage")},this.remove=function(){console.warn("Remove is not supported by the SimpleStaticStorage")}},PS.API.SimpleSynthLinker=new function(){var a="",b=this,c="You need to initialize the SimpleSynthLinker to be able to use it!\nYou need to add PS.API.SimpleSynthLinker.init(_simpleSynthLinkerURL, _simpleSynthLinkerPort);";this.init=function(d,e,f){d&&e?(a="http://"+d+":"+e+"/",new PS.Utils.Request(a+"status",{onComplete:function(a){console.log("Linker service running: "+a.responseText),f&&f(b)},onError:function(){console.warn("You need to run the fake node.js linker service"),f&&f()}})):console.warn(c)},this.create=function(b){a?new PS.Utils.Request(a+"requests",{method:"POST",content:JSON.stringify(b),onComplete:function(a){var b=JSON.parse(a.responseText);console.log(b)}}):console.warn(c)}};